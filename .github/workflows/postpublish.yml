name: postpublish
on:
  workflow_run:
    workflows: ["weekly"]
    types: [completed]

jobs:
  post:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      TZ: Europe/Sarajevo
      N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
      N8N_API_TOKEN: ${{ secrets.N8N_API_TOKEN }}   # <— NOVO

    steps:
      - name: Build payload
        run: |
          cat > payload.json <<'JSON'
          {
            "repo": "${{ github.event.workflow_run.repository.full_name }}",
            "branch": "${{ github.event.workflow_run.head_branch }}",
            "head_sha": "${{ github.event.workflow_run.head_sha }}",
            "run_id": "${{ github.event.workflow_run.id }}",
            "run_number": "${{ github.event.workflow_run.run_number }}",
            "run_attempt": "${{ github.event.workflow_run.run_attempt }}",
            "run_url": "${{ github.event.workflow_run.html_url }}",
            "artifacts_url": "${{ github.event.workflow_run.artifacts_url }}",
            "created_at": "${{ github.event.workflow_run.created_at }}",
            "name": "${{ github.event.workflow_run.name }}"
          }
          JSON
          echo "Payload built:"
          cat payload.json

      - name: Debug N8N_WEBHOOK_URL
        run: |
          RAW="${N8N_WEBHOOK_URL:-}"
          echo "Len(raw)=$(( ${#RAW} ))"
          printf '%s' "$RAW" | hexdump -C | head || true

      - name: Call n8n (header token auth)
        shell: bash
        run: |
          set -euo pipefail

          URL_CLEAN="$(printf '%s' "${N8N_WEBHOOK_URL:-}" | tr -d '\r' | sed 's/^[ \t]*//;s/[ \t]*$//')"
          test -n "$URL_CLEAN" || { echo "❌ N8N_WEBHOOK_URL empty"; exit 1; }
          echo "➡️  Using webhook: $(echo "$URL_CLEAN" | sed 's,^\(https\?://.\{5\}\).*,\1…(masked),')"

          curl -sS \
            --fail-with-body \
            --retry 3 \
            --retry-delay 2 \
            --max-time 20 \
            -A "github-actions-postpublish" \
            -X POST "$URL_CLEAN" \
            -H 'Content-Type: application/json' \
            -H 'X-GH-Workflow: postpublish' \
            -H 'X-GH-Repo: ${{ github.repository }}' \
            -H 'X-GH-Run-URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}' \
            -H "x-internal-token: ${N8N_API_TOKEN}" \
            --data-binary @payload.json
